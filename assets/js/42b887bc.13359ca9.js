"use strict";(self.webpackChunkredback_documentation=self.webpackChunkredback_documentation||[]).push([[4313],{29811:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>d});var r=n(74848),i=n(28453);const a={sidebar_position:15},o="Two Factor Authentication",s={id:"cybersecurity/research/two-factor-authentication",title:"Two Factor Authentication",description:"Research Piece",source:"@site/docs/cybersecurity/research/two-factor-authentication.md",sourceDirName:"cybersecurity/research",slug:"/cybersecurity/research/two-factor-authentication",permalink:"/redback-documentation/docs/cybersecurity/research/two-factor-authentication",draft:!1,unlisted:!1,editUrl:"https://github.com/Redback-Operations/redback-documentation/blob/main/docs/cybersecurity/research/two-factor-authentication.md",tags:[],version:"current",sidebarPosition:15,frontMatter:{sidebar_position:15},sidebar:"tutorialSidebar",previous:{title:"Security Information and Event Management Systems",permalink:"/redback-documentation/docs/cybersecurity/research/SIEM-research"},next:{title:"TPM Research",permalink:"/redback-documentation/docs/cybersecurity/research/tpm-research"}},c={},d=[{value:"Signup",id:"signup",level:2},{value:"QR Code Generation",id:"qr-code-generation",level:2},{value:"Authentication",id:"authentication",level:2}];function l(e){const t={admonition:"admonition",code:"code",h1:"h1",h2:"h2",img:"img",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h1,{id:"two-factor-authentication",children:"Two Factor Authentication"}),"\n",(0,r.jsx)(t.p,{children:"Research Piece"}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Author:"})," Muhammad Khurram Zeeshan"]})}),"\n",(0,r.jsx)(t.p,{children:"2FA (Two Factor Authentication) via an authenticator app works by using a secret phrase. When a user signs up by providing an email address, a secret phrase is generated for that user. Based on that secret, a QR code is generated. User then scans that QR code in the mobile app (google authenticator, lastpass etc). Using the time at that moment and that QR Code, an authentication code(TOTP - Time Based One Time Password) is generated every 30 seconds. User enters that authentication code on the login page to authenticate the oneself."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"2FA Graph",src:n(45744).A+"",width:"601",height:"448"})}),"\n",(0,r.jsx)(t.p,{children:"Since I had access to neither Redback\u2019s backend nor MongoDB(referred to in the front end code), I set up VM\u2019s using Sandbox on my laptop and tested/implemented 2FA. The following bits of the current website would need modification to incorporate the 2FA. Dependencies like otplib and qrcode would need to be installed prior to the implementation of following."}),"\n",(0,r.jsx)(t.h2,{id:"signup",children:"Signup"}),"\n",(0,r.jsx)(t.p,{children:"This part asks the new users to sign-up and become members. Users are asked to enter their email address."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'<!DOCTYPE html> \r\n<html lang="en"> \r\n<head> \r\n  <meta charset="UTF-8"> \r\n  <meta http-equiv="X-UA-Compatible" content="IE=edge"> \r\n  <meta name="viewport" content="width=device-width, initial-scale=1.0"> \r\n  <title>Sign Up</title> \r\n  <link \r\nhref="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.c ss" rel="stylesheet"      integrity="sha384-\r\n1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"> \r\n</head> \r\n<body> \r\n  <div class="container mx-auto mt-4"> \r\n    <h1>SIGN UP</h1> \r\n    <form action="/signup" method="POST"> \r\n      <div class="mb-3"> \r\n        <label for="emailad" class="form-label">Email</label>         <input type="emailad" class="form-control" id="emailad" name="emailad"> \r\n      </div> \r\n      <button type="submit" class="btn btn-primary">Sign Up</button> \r\n    </form> \r\n    <p class="mt-4"> \r\n      Have an account? <a href="/login">Login</a> \r\n    </p> \r\n  </div> \r\n</body> \r\n</html> \n'})}),"\n",(0,r.jsx)(t.p,{children:"The above code would ask user to enter their email address and once its submitted, user will be redirected to authentication page."}),"\n",(0,r.jsx)(t.h2,{id:"qr-code-generation",children:"QR Code Generation"}),"\n",(0,r.jsx)(t.p,{children:"In the backend (Node js), a POST route is created to complete registration. Email provided at sign up is retrieved to create the secret phrase that would be used to generate the QR code."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"app.post('/signup', (req, res) => {   const emailad = req.body.email,     phrase = authenticator.generateSecret() \r\n \r\n  const db = new sqlite3.Database('db.sqlite')   db.serialize(() => { \r\n    db.run('INSERT INTO `users`(`emailad`, `phrase`) VALUES (?, ?)', \r\n      [emailad, phrase],       (err) => {         if (err) {           throw err \r\n        } \r\n        QRCode.toDataURL(authenticator.keyuri(emailad, '2FA Node App', phrase), (err, url) => {           if (err) {             throw err \r\n          } \r\n \r\n          req.session.qr = url           req.session.email = emailad           res.redirect('/ 2FA-Sign') \r\n        }) \r\n      }) \r\n  }) \r\n})  \n"})}),"\n",(0,r.jsx)(t.p,{children:"A base32 HEX will be generated."}),"\n",(0,r.jsx)(t.p,{children:"The next step would involve creating a new user in database using the email address and secret phrase. A QR Code would be generated with that info. I used a local database on my local machine for this so excluding that step here as that wont be relevant to Redback website\u2019s scenario. This step would need to be modified based on how MongoDB is setup for Redback."}),"\n",(0,r.jsx)(t.p,{children:"Below code verifies after the user has scanned the QR Code on their mobile. It asks user to enter the TOTP generated on their authenticator app."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'<!DOCTYPE html> \r\n<html lang="en"> \r\n<head> \r\n  <meta charset="UTF-8"> \r\n  <meta http-equiv="X-UA-Compatible" content="IE=edge"> \r\n  <meta name="viewport" content="width=device-width, initial-scale=1.0"> \r\n  <title>Sign Up - Set 2FA</title> \r\n  <link \r\nhref="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.c ss" rel="stylesheet"      integrity="sha384-\r\n1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"> \r\n</head> \r\n<body> \r\n  <div class="container mx-auto mt-4"> \r\n    <h1>Sign Up & Activate 2FA</h1> \r\n    <form action="/2FA-Sign" method="POST"> \r\n      <p>Scan this QR Code in your authenticator app. Once done, enter the passphrase generated in the app on here and click Submit.</p> \r\n      <img src="<%= qr %>" class="img-fluid" /> \r\n      <div class="mb-3"> \r\n        <label for="code" class="form-label">2FA Code</label> \r\n        <input type="text" class="form-control" id="code" name="code">       </div> \r\n      <button type="submit" class="btn btn-primary">Submit</button> \r\n    </form> \r\n  </div> \r\n</body> \r\n</html> \n'})}),"\n",(0,r.jsx)(t.h2,{id:"authentication",children:"Authentication"}),"\n",(0,r.jsx)(t.p,{children:"In the backend (Node js), following route is created to get the user\u2019s email and TOTP from the session."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"app.post('/ 2FA-Sign ', (req, res) => {   if (!req.session.email) {     return res.redirect('/') \r\n  }  \r\n  const emailad = req.session.email,     code = req.body.code \r\n \r\n  return Loginverification(emailad, code, req, res, '/ 2FA-Sign') \r\n}) \n"})}),"\n",(0,r.jsx)(t.p,{children:"The above code calls on routine Loginverification which compares the TOTP and confirms if authentication is successful or not. Below is Loginverification routine\u2019s code ."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"function Loginverification (emailad, code, req, res, failUrl) { \r\n   \r\n  const db = new sqlite3.Database('db.sqlite')   db.serialize(() => { \r\n    db.get('SELECT phrase FROM users WHERE email = ?', [emailad], (err, row) => {       if (err) {         throw err \r\n      }  \r\n      if (!row) { \r\n        return res.redirect('/') \r\n      }  \r\n      if (!authenticator.check(code, row.phrase)) { \r\n         \r\n        return res.redirect(failUrl) \r\n      } \r\n      req.session.qr = null       req.session.email = null \r\n      req.session.token = jwt.sign(emailad, 'supersecret') \r\n \r\n      return res.redirect('/loggedin') \r\n    }) \r\n  }) \r\n} \n"})})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},45744:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/2fa-graph-a4ad6722b3410372eb3439ae5adb4553.jpg"},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>s});var r=n(96540);const i={},a=r.createContext(i);function o(e){const t=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:t},e.children)}}}]);